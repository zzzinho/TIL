
# 싱글톤 레지스트리와 오브젝트 스코프
- [싱글톤 레지스트리와 오브젝트 스코프](#싱글톤-레지스트리와-오브젝트-스코프)
  - [싱글톤 레지스트리로서의 애플리케이션 컨텍스트](#싱글톤-레지스트리로서의-애플리케이션-컨텍스트)
    - [서버 애플리케이션과 싱글톤](#서버-애플리케이션과-싱글톤)
    - [싱글톤 패턴의 한계](#싱글톤-패턴의-한계)
      - [싱글톤 패턴을 적용한 UserDao](#싱글톤-패턴을-적용한-userdao)
      - [싱글톤 패턴 문제점](#싱글톤-패턴-문제점)
    - [싱글톤 레지스트리](#싱글톤-레지스트리)
  - [싱글톤과 오브젝트의 상태](#싱글톤과-오브젝트의-상태)
  - [스프링 빈의 스코프](#스프링-빈의-스코프)
    - [스코드 종류](#스코드-종류)


> 이전에 만든 DaoFactory와 애플리케이션 컨텍스트의 차이는 팩토리를 매번 dao 오브젝트를 생성해서 주지만 애플리케이션 컨텍스트는 같은 오브젝트를 반환한다.

## 싱글톤 레지스트리로서의 애플리케이션 컨텍스트
- 애플리케이션 컨텍스트는 오브젝트 팩토리와 비슷한 방식으로 동작하는 IoC 컨테이너이다.
- 애플리케이션 컨텍스트는 싱글톤을 저장하고 관리하는 `싱글톤 레지스트리(singleton registry)`이다. 

### 서버 애플리케이션과 싱글톤
- 스프링은 왜 싱글톤으로 빈을 만들까?
  - 스프링은 서버 환경에서 사용된다.
  - 서버는 한번에 많은 요청을 처리해야하기 때문에 매번 로직을 담당하는 오브젝트를 생성하면 메모리를 관리하기 어렵다.

### 싱글톤 패턴의 한계
- 자바에서 싱글톤을 구현하는 방법
  - 클래스 밖에서는 오브젝트를 생성할 수 없게 private로 지정
  - 생성된 싱글톤 오브젝트를 저장할 수 있는 자신과 같은 타입의 스태틱 필드 정의
  - 스태틱 팩토리 메소드인 getInstance()를 만들고 해당 메소드가 최초로 호출되는 시점에서 한번만 오브젝트가 만들어진다. 생성된 오브젝트는 스태틱 필드에 저장. 또는 스태틱 필드의 초기값으로 오브젝트를 미리 만들어 둘 수 있다. -> 만들어서 가져오고 보관 또는 미리 보관해두고 꺼내온다.
  - 한번 오브젝트가 만들어지고 난 후 에는 getInstance() 메소드를 통해 이미 만들어져 스태틱 필드에 저장해둔 오브젝트를 넘겨준다.

#### 싱글톤 패턴을 적용한 UserDao
```java
public class UserDao {
    private static UserDao INSTANCE;

    private UserDao userDao(ConnectionMaker connectionmaker) {
        this.connectionMaker = connectionMaker;
    }

    public static synchronized UserDao getInstance() {
        if(INSTANCE == null) INSTANCE = new UserDao(???);
        return INSTACE;
    }
}
```
- `private` 생성자로 인해서 외부에서 호출할 수 없다. -> DaoFactory에서 UserDao를 생성하며 ConnectionMaker 오브젝트를 넣어주는게 불가능 해짐

#### 싱글톤 패턴 문제점
- private 생성자를 갖고 있기 때문에 상속할 수 없다.
  - 다른 생성자가 없다면 상속이 불가능
  - 상속과 다형성의 장점을 사용할 수 없음
- 싱글톤은 테스트하기 힘들다.
  - 생성되는 방식이 제한적이기 때문에 목 오브젝트 등으로 대체하기 어렵다.
  - 싱글톤은 초기화 과정에서 생성자 등을 통해 사용할 오브젝트를 동적으로 주입하기 힘들기 때문에 필요한 오브젝트는 직접 오브젝트를 만들어 사용할 수 밖에 없다. 
- 서버 환경에서는 싱글톤이 하나만 만들어지는 것을 보장하지 못한다.
  - 클래스 로더를 어떻게 구성하냐에 따라 하나 이상의 오브젝트가 생성될 수 있다.
  - 어려개의 jVM에 분산돼서 설치가 되는 경우에도 독립적으로 오브젝트가 생기기 때문에 싱글톤으로서의 가치가 떨어진다.
- 싱글톤의 사용은 전역 상태를 만들수 있기 때문에 바람직하지 못하다.
  - 싱글톤은 사용하는 클라이언트가 정해져있지 않다.
  - 싱글톤의 스태틱 메소드를 이용하여 싱글톤에 쉽게 접근할 수 있기에 애플리케이션 어디서든지 사용될 수 있어 전역상태로 사용되기 쉽다.
  - 전역 상태는 객체지향에서 지양하는 모델이다.

### 싱글톤 레지스트리
> 그럼에도 불구하고 스프링은 싱글톤이 만들어져서 서비스 오브젝트 방식으로 사용되는 것을 지향한다.

이러한 문제점들을 해결하기 위해서 `싱글톤 레지스트리(Singleton Registiry)`를 통해서 싱글톤 형태의 오브젝트를 만들고 관리하는 기능을 사용한다.

- 스태틱 메소드와 private 생성자를 사용해야하는 비정상적인 클래스가 아니라 평범한 자바 클래스를 싱글톤으로 활용하게 해준다.
- IoC 방식의 컨테이너를 사용해서 생성과 관계설정, 사용 등에 대한 제어권을 컨테이너에게 위임한다.
- 싱글톤 레지스트리에 권한을 위임했기 때문에 public 생성자를 사용할 수 있다.
- 테스트를위한 목 오브젝트로 대체하는 것도 간단하다

-> 싱글톤 패턴과 달리 스프링이 지지하는 객체지향적인 설계방식과 원칙, 디자인 패턴 등을 적용하는데 아무런 제약이 없다.

## 싱글톤과 오브젝트의 상태
- 싱글톤은 멀티스레드 환경이라면 여러 스레드가 동시에 접근해서 사용할 수 있다.
  - 상태관리에 주의를 요함
- 사기본적으로 상태정보를 내부에 갖고있지 않은 무상태 방식으로 만들어져야한다.
  - 상태가 없는 방식으로 클래스를 만드는 경우에 각 쵸정에 대한 정보 또는 데이터베이스, 서버의 리소스로부터 생성한 정보는 파라미터와 로컬 변수, 리턴 값 등을 이용해서 다룬다.

## 스프링 빈의 스코프
> 스코프(scope): 빈이 생성되고, 존재하고, 적용하는 범위

- 싱글톤 스코프는 컨테이너 내에 한 개의 오브젝트만 만들어지고 강제로 제거하지 않는 이상 스프링 컨테이너가 존재하는 동안 계속 유지된다. 
- 스프링에서 만들어지는 대부분 빈 오브젝트는 싱글톤 스코프를 갖는다.

### 스코드 종류
- 프로토타입(prototype): 컨테이너에 빈을 요청할 때마다 매번 새로운 오브젝트 생성
- 요청(request): HTTP 요청이 생길 때마다 생성
- 세션(session): 웹의 세션과 유사한 스코프